<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Tracker Test</title>
</head>
<body>
    <div id="activeJobs" class="hidden">
        <div>
            <h3>Processing Status</h3>
            <div id="jobsList"></div>
        </div>
    </div>
    
    <button onclick="testProgressTracker()">Test Progress Tracker</button>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Simple mock API for testing
        window.API = {
            getJobStatus: async (jobId) => {
                // Simulate different job states
                return {
                    id: jobId,
                    status: Math.random() > 0.5 ? 'processing' : 'completed',
                    progress: Math.floor(Math.random() * 100),
                    original_filename: 'test.pdf',
                    compression_ratio: 0.5,
                    download_url: '/download/' + jobId
                };
            }
        };
        
        // Simple ProgressTracker class for testing
        class ProgressTracker {
            constructor() {
                this.activeJobs = new Map();
                this.pollInterval = 2000;
                this.isPolling = false;
                this.init();
            }
            
            init() {
                this.jobsList = document.getElementById('jobsList');
            }
            
            addJob(jobId) {
                this.activeJobs.set(jobId, { id: jobId });
                this.createJobElement(jobId);
                this.startPolling();
                
                // Show active jobs section
                const section = document.getElementById('activeJobs');
                if (section) section.classList.remove('hidden');
            }
            
            createJobElement(jobId) {
                if (!this.jobsList) return;
                const el = document.createElement('div');
                el.id = `job-${jobId}`;
                el.innerHTML = `<p>Job ${jobId}: Processing...</p>`;
                this.jobsList.appendChild(el);
            }
            
            startPolling() {
                if (this.isPolling) return;
                this.isPolling = true;
                this.pollJobs();
            }
            
            async pollJobs() {
                if (!this.isPolling) return;
                
                for (let jobId of this.activeJobs.keys()) {
                    const jobData = await window.API.getJobStatus(jobId);
                    const el = document.getElementById(`job-${jobId}`);
                    if (el) {
                        el.innerHTML = `<p>Job ${jobId}: ${jobData.status} (${jobData.progress}%)</p>`;
                        if (jobData.status === 'completed') {
                            this.activeJobs.delete(jobId);
                        }
                    }
                }
                
                if (this.activeJobs.size > 0) {
                    setTimeout(() => this.pollJobs(), this.pollInterval);
                } else {
                    this.isPolling = false;
                }
            }
        }
        
        window.ProgressTracker = new ProgressTracker();
        
        function testProgressTracker() {
            const jobId = Math.floor(Math.random() * 1000);
            console.log('Testing with job ID:', jobId);
            window.ProgressTracker.addJob(jobId);
        }
    </script>
</body>
</html>
