{% extends "base.html" %}

{% block title %}Processing History - PDF Compressor{% endblock %}

{% block extra_head %}
<style>
    /* Disable focus rings and animations */
    .file-checkbox:focus {
        box-shadow: none !important;
        outline: none !important;
        border-color: #3b82f6 !important;
    }
    
    /* Disable text selection during multi-select */
    .file-item {
        transition: none !important;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    .file-item:hover {
        background-color: transparent !important;
        transform: none !important;
    }
    
    /* Prevent text selection on shift+click */
    .selecting {
        user-select: none !important;
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
    }
    
    /* Minimalist filter buttons */
    .filter-button {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
        background: transparent;
        border: none;
        border-radius: 0.375rem;
        transition: none;
    }
    .filter-button:hover {
        background: transparent !important;
    }
    .filter-button.active {
        color: #1f2937;
        background: #f3f4f6;
    }
    
    /* Clean search input */
    .search-input {
        background: #ffffff;
        border: 1px solid #d1d5db;
        transition: border-color 0.15s ease;
    }
    .search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #3b82f6;
        outline: none;
    }
    
    /* Simple pagination */
    .pagination-button {
        border-radius: 0.375rem;
        color: #6b7280;
        background: #ffffff;
        border: 1px solid #d1d5db;
        transition: none;
    }
    .pagination-button:hover {
        background: #ffffff !important;
        transform: none !important;
    }
    .pagination-button.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    
    /* Minimal empty state */
    .empty-state {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-style: dashed;
        border-radius: 0.5rem;
    }
    
    /* Clean time button */
    .relative-time-btn {
        background: transparent;
        border: none;
        padding: 0;
        color: inherit;
        font-size: inherit;
        transition: none;
    }
    .relative-time-btn:hover {
        background: transparent !important;
        transform: none !important;
    }
    
    /* Selection controls animations */
    .transition-opacity {
        transition: opacity 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Simple Header -->
    <div class="mb-6">
        <h1 class="text-xl font-semibold text-gray-900">Processing History</h1>
    </div>

    <!-- Modern Selection/Filter Bar -->
    <div class="relative bg-white border border-gray-100 rounded-lg">
        <!-- Main Filter Bar -->
        <div id="mainFilterBar" class="flex items-center justify-between px-4 py-3 transition-opacity duration-300">
            <div class="flex space-x-1">
                <button class="filter-button active" data-filter="all">All</button>
                <button class="filter-button" data-filter="recent">Recent</button>
                <button class="filter-button" data-filter="completed">Completed</button>
                <button class="filter-button" data-filter="processing">Processing</button>
                <button class="filter-button" data-filter="failed">Failed</button>
            </div>
            
            <div class="relative">
                <input type="text" id="searchInput" class="search-input w-64 pl-8 pr-3 py-1.5 text-sm border border-gray-200 rounded-md focus:outline-none focus:border-blue-400" placeholder="Search files...">
                <svg class="absolute left-2.5 top-2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
        </div>
        
        <!-- Selection Bar (overlays only the filter section, not search) -->
        <div id="selectionBar" class="absolute top-0 left-0 right-80 bg-gray-50 border border-gray-200 rounded-l-lg px-4 py-3 opacity-0 pointer-events-none transition-all duration-300 transform translate-y-1 z-10">
            <div class="flex items-center space-x-6">
                <span class="text-sm font-medium text-gray-800">
                    <span id="selectedCount">0</span> files selected
                </span>
                <button type="button" id="selectAll" class="text-sm text-blue-600 font-medium hover:text-blue-700">
                    Select all
                </button>
                <button type="button" id="clearSelection" class="text-sm text-gray-500 hover:text-gray-600">
                    Clear
                </button>
                <button type="button" id="downloadSelected" class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed ml-4" disabled>
                    Download ZIP
                </button>
            </div>
        </div>
        
        <!-- Sticky Selection Bar for scrolling -->
        <div id="stickySelectionBar" class="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 px-4 py-3 opacity-0 pointer-events-none transition-all duration-300 transform -translate-y-full z-50 shadow-sm">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <span class="text-sm font-medium text-gray-800">
                        <span id="stickySelectedCount">0</span> files selected
                    </span>
                    <button type="button" id="stickySelectAll" class="text-sm text-blue-600 font-medium hover:text-blue-700">
                        Select all
                    </button>
                    <button type="button" id="stickyClearSelection" class="text-sm text-gray-500 hover:text-gray-600">
                        Clear
                    </button>
                </div>
                <button type="button" id="stickyDownloadSelected" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-4-4m4 4l4-4m3 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Download ZIP
                </button>
            </div>
        </div>
    </div>

    <!-- Clean File List -->
    <div class="bg-white border border-gray-100 rounded-lg overflow-hidden">
        {% if jobs.items %}
            {% for job in jobs.items %}
            <div class="file-item border-b border-gray-50 last:border-b-0 cursor-pointer" data-status="{{ job.status }}" data-filename="{{ job.original_filename.lower() }}" data-job-id="{{ job.id }}">
                <div class="flex items-center px-4 py-3" onclick="handleRowClick(event, this.parentElement)">
                    <!-- Index Number -->
                    <span class="flex-shrink-0 w-6 text-sm text-gray-400 mr-3">{{ loop.index }}</span>
                    
                    <!-- Checkbox -->
                    {% if job.status == 'completed' and not job.is_expired %}
                    <input type="checkbox" class="file-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded mr-3 focus:ring-0 focus:ring-offset-0" 
                           data-job-id="{{ job.id }}" data-filename="{{ job.original_filename }}">
                    {% else %}
                    <input type="checkbox" class="file-checkbox w-4 h-4 text-gray-300 border-gray-200 rounded mr-3 cursor-not-allowed focus:ring-0 focus:ring-offset-0" 
                           data-job-id="{{ job.id }}" data-filename="{{ job.original_filename }}" disabled>
                    {% endif %}
                    
                    <!-- File Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <p class="text-sm font-medium text-gray-900 truncate">{{ job.original_filename }}</p>
                                    {% if not job.is_expired %}
                                        {% if job.status == 'completed' %}
                                        <span class="text-xs px-2 py-0.5 bg-green-100 text-green-800 rounded">completed</span>
                                        {% elif job.status == 'failed' %}
                                        <span class="text-xs px-2 py-0.5 bg-red-100 text-red-800 rounded">failed</span>
                                        {% elif job.status == 'processing' %}
                                        <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded">processing</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="flex items-center space-x-3 text-xs text-gray-500">
                                    <span>{{ job.original_size | filesizeformat }}</span>
                                    {% if job.processed_size and job.original_size %}
                                    <span>→ {{ job.processed_size | filesizeformat }}</span>
                                    {% endif %}
                                    <span>{{ job.quality_preset }}% quality</span>
                                    <button class="relative-time-btn text-gray-500" 
                                            data-timestamp="{{ job.created_at | ist_iso }}" 
                                            data-full-time="{{ job.created_at | ist_datetime }}"
                                            onclick="toggleTimeDisplay(this)">
                                        <span class="relative-time">{{ job.created_at | ist_datetime }}</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Action -->
                            <div class="flex-shrink-0 ml-4">
                                {% if job.status == 'completed' and not job.is_expired %}
                                    <a href="{{ url_for('main.download_file', job_id=job.id) }}"
                                       class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">
                                        Download
                                    </a>
                                {% elif job.is_expired %}
                                    <span class="text-sm text-gray-400">Expired</span>
                                {% elif job.status == 'processing' %}
                                    <button class="text-sm text-blue-600 hover:text-blue-700" onclick="refreshJobStatus('{{ job.id }}')">
                                        Refresh
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if job.error_message %}
                        <div class="mt-2 text-xs text-red-600 bg-red-50 px-2 py-1 rounded">
                            {{ job.error_message }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Simple Pagination -->
            {% if jobs.pages > 1 %}
            <div class="border-t border-gray-100 px-4 py-3">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-500">
                        {{ jobs.per_page * (jobs.page - 1) + 1 }}-{{ jobs.per_page * jobs.page if jobs.page < jobs.pages else jobs.total }} of {{ jobs.total }}
                    </span>
                    <div class="flex space-x-1">
                        {% if jobs.has_prev %}
                            <a href="{{ url_for('main.history', page=jobs.prev_num) }}" 
                               class="pagination-button px-3 py-1 text-gray-600">← Prev</a>
                        {% endif %}
                        {% if jobs.has_next %}
                            <a href="{{ url_for('main.history', page=jobs.next_num) }}" 
                               class="pagination-button px-3 py-1 text-gray-600">Next →</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

        {% else %}
            <!-- Clean Empty State -->
            <div class="empty-state text-center py-12 mx-4 my-4">
                <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="mt-4 text-sm font-medium text-gray-900">No files yet</h3>
                <p class="mt-1 text-sm text-gray-500">Start compressing PDFs to see them here.</p>
                <div class="mt-6">
                    <a href="{{ url_for('main.dashboard') }}" 
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600">
                        Compress PDF
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Utility functions
function formatRelativeTime(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diffInSeconds = Math.floor((now - time) / 1000);
    
    if (diffInSeconds < 60) {
        return diffInSeconds <= 5 ? 'now' : `${diffInSeconds} seconds ago`;
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 604800) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} day${days !== 1 ? 's' : ''} ago`;
    } else {
        const weeks = Math.floor(diffInSeconds / 604800);
        return `${weeks} week${weeks !== 1 ? 's' : ''} ago`;
    }
}

function checkFilterMatch(item, filter) {
    if (filter === 'all') return true;
    
    if (filter === 'recent') {
        const timestamps = Array.from(document.querySelectorAll('.relative-time-btn')).map(btn => 
            new Date(btn.dataset.timestamp).getTime()
        );
        const mostRecent = Math.max(...timestamps);
        const cutoff = mostRecent - (24 * 60 * 60 * 1000);
        const itemTimestamp = new Date(item.querySelector('.relative-time-btn').dataset.timestamp).getTime();
        return itemTimestamp >= cutoff;
    }
    
    return item.dataset.status === filter;
}

function updateItemVisibility() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const activeFilter = document.querySelector('.filter-button.active')?.dataset.filter || 'all';
    const fileItems = document.querySelectorAll('.file-item');
    
    fileItems.forEach(item => {
        const filename = item.dataset.filename;
        const matchesSearch = searchTerm === '' || filename.includes(searchTerm);
        const matchesFilter = checkFilterMatch(item, activeFilter);
        
        if (matchesSearch && matchesFilter) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Multi-selection functionality
let lastClickedIndex = -1;
let selectedFiles = new Set();

function showFlashMessage(message, type = 'error') {
    // Remove existing flash messages
    const existingFlash = document.querySelector('.flash-message');
    if (existingFlash) {
        existingFlash.remove();
    }
    
    // Create new flash message
    const flashDiv = document.createElement('div');
    flashDiv.className = `flash-message fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg ${
        type === 'error' ? 'bg-red-50 border border-red-200 text-red-800' : 'bg-green-50 border border-green-200 text-green-800'
    }`;
    flashDiv.innerHTML = `
        <div class="flex">
            <div class="flex-shrink-0">
                ${type === 'error' ? 
                    '<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' :
                    '<svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                }
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium">${message}</p>
            </div>
            <div class="ml-auto pl-3">
                <button type="button" class="inline-flex rounded-md p-1.5 focus:outline-none" onclick="this.parentElement.parentElement.parentElement.remove()">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(flashDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (flashDiv.parentNode) {
            flashDiv.remove();
        }
    }, 5000);
}

function updateSelectionUI() {
    const count = selectedFiles.size;
    const filterButtons = document.querySelectorAll('.filter-button');
    const selectionBar = document.getElementById('selectionBar');
    const stickySelectionBar = document.getElementById('stickySelectionBar');
    const selectedCountElement = document.getElementById('selectedCount');
    const stickySelectedCountElement = document.getElementById('stickySelectedCount');
    const downloadButton = document.getElementById('downloadSelected');
    const stickyDownloadButton = document.getElementById('stickyDownloadSelected');
    
    // Update both count displays
    selectedCountElement.textContent = count;
    stickySelectedCountElement.textContent = count;
    
    if (count > 0) {
        // Show selection bars and dim filter buttons
        selectionBar.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-1');
        selectionBar.classList.add('opacity-100', 'pointer-events-auto', 'translate-y-0');
        filterButtons.forEach(btn => btn.classList.add('opacity-30'));
        downloadButton.disabled = false;
        stickyDownloadButton.disabled = false;
        
        // Enable scroll detection for sticky bar
        window.addEventListener('scroll', handleScroll);
        
        // Immediately check if we need to show sticky bar
        handleScroll();
    } else {
        // Hide selection bars and restore filter buttons
        selectionBar.classList.add('opacity-0', 'pointer-events-none', 'translate-y-1');
        selectionBar.classList.remove('opacity-100', 'pointer-events-auto', 'translate-y-0');
        stickySelectionBar.classList.add('opacity-0', 'pointer-events-none', '-translate-y-full');
        stickySelectionBar.classList.remove('opacity-100', 'pointer-events-auto', 'translate-y-0');
        filterButtons.forEach(btn => btn.classList.remove('opacity-30'));
        downloadButton.disabled = true;
        stickyDownloadButton.disabled = true;
        
        // Disable scroll detection
        window.removeEventListener('scroll', handleScroll);
    }
}

function handleScroll() {
    if (selectedFiles.size === 0) return;
    
    const filterBar = document.querySelector('.relative.bg-white.border.border-gray-100.rounded-lg');
    const stickySelectionBar = document.getElementById('stickySelectionBar');
    
    if (!filterBar || !stickySelectionBar) return;
    
    const filterBarRect = filterBar.getBoundingClientRect();
    const isFilterBarVisible = filterBarRect.bottom > 0;
    
    if (!isFilterBarVisible) {
        // Show sticky bar
        stickySelectionBar.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-full');
        stickySelectionBar.classList.add('opacity-100', 'pointer-events-auto', 'translate-y-0');
    } else {
        // Hide sticky bar
        stickySelectionBar.classList.add('opacity-0', 'pointer-events-none', '-translate-y-full');
        stickySelectionBar.classList.remove('opacity-100', 'pointer-events-auto', 'translate-y-0');
    }
}

function handleCheckboxClick(checkbox, event) {
    event.stopPropagation(); // Prevent row click when clicking checkbox
    
    // Prevent text selection on shift+click
    if (event.shiftKey) {
        event.preventDefault();
        document.body.classList.add('selecting');
        setTimeout(() => document.body.classList.remove('selecting'), 100);
    }
    
    const jobId = checkbox.dataset.jobId;
    const checkboxes = Array.from(document.querySelectorAll('.file-checkbox:not([disabled])'));
    const currentIndex = checkboxes.indexOf(checkbox);
    
    // Handle Shift+Click for range selection
    if (event.shiftKey && lastClickedIndex !== -1) {
        const start = Math.min(lastClickedIndex, currentIndex);
        const end = Math.max(lastClickedIndex, currentIndex);
        
        for (let i = start; i <= end; i++) {
            const cb = checkboxes[i];
            if (cb && !cb.disabled) {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedFiles.add(cb.dataset.jobId);
                } else {
                    selectedFiles.delete(cb.dataset.jobId);
                }
            }
        }
    } else {
        // Single checkbox toggle
        if (checkbox.checked) {
            selectedFiles.add(jobId);
        } else {
            selectedFiles.delete(jobId);
        }
    }
    
    lastClickedIndex = currentIndex;
    updateSelectionUI();
}

function handleRowClick(event, fileItem) {
    // Don't trigger if clicking on interactive elements
    if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON' || event.target.closest('a, button')) {
        return;
    }
    
    const checkbox = fileItem.querySelector('.file-checkbox');
    if (!checkbox || checkbox.disabled) {
        return;
    }
    
    // Prevent text selection on shift+click
    if (event.shiftKey) {
        event.preventDefault();
        document.body.classList.add('selecting');
        setTimeout(() => document.body.classList.remove('selecting'), 100);
    }
    
    // Toggle checkbox and handle range selection
    checkbox.checked = !checkbox.checked;
    
    const jobId = checkbox.dataset.jobId;
    const checkboxes = Array.from(document.querySelectorAll('.file-checkbox:not([disabled])'));
    const currentIndex = checkboxes.indexOf(checkbox);
    
    // Handle Shift+Click for range selection
    if (event.shiftKey && lastClickedIndex !== -1) {
        const start = Math.min(lastClickedIndex, currentIndex);
        const end = Math.max(lastClickedIndex, currentIndex);
        
        for (let i = start; i <= end; i++) {
            const cb = checkboxes[i];
            if (cb && !cb.disabled) {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedFiles.add(cb.dataset.jobId);
                } else {
                    selectedFiles.delete(cb.dataset.jobId);
                }
            }
        }
    } else {
        // Single selection
        if (checkbox.checked) {
            selectedFiles.add(jobId);
        } else {
            selectedFiles.delete(jobId);
        }
    }
    
    lastClickedIndex = currentIndex;
    updateSelectionUI();
}

function selectAllDownloadable() {
    const checkboxes = document.querySelectorAll('.file-checkbox:not([disabled])');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        selectedFiles.add(checkbox.dataset.jobId);
    });
    updateSelectionUI();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectedFiles.clear();
    updateSelectionUI();
}

async function downloadSelected() {
    if (selectedFiles.size === 0) return;
    
    const downloadButton = document.getElementById('downloadSelected');
    const originalText = downloadButton.innerHTML;
    
    // Show loading state
    downloadButton.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...';
    downloadButton.disabled = true;
    
    try {
        const jobIds = Array.from(selectedFiles);
        const response = await fetch('/download-batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ job_ids: jobIds })
        });
        
        if (response.ok) {
            // Create a blob from the response
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            
            // Create a temporary download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `compressed_files_${new Date().toISOString().split('T')[0]}.zip`;
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showFlashMessage(`Successfully downloaded ${jobIds.length} files as ZIP archive.`, 'success');
            clearSelection();
        } else {
            const errorData = await response.json();
            showFlashMessage(errorData.message || 'Failed to download files. Please try again.');
        }
    } catch (error) {
        console.error('Download error:', error);
        showFlashMessage('Network error occurred. Please check your connection and try again.');
    } finally {
        // Restore button state
        downloadButton.innerHTML = originalText;
        downloadButton.disabled = selectedFiles.size === 0;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize relative time display
    document.querySelectorAll('.relative-time-btn').forEach(button => {
        const span = button.querySelector('.relative-time');
        span.textContent = formatRelativeTime(button.dataset.timestamp);
    });
    
    // Update relative times every minute
    setInterval(() => {
        document.querySelectorAll('.relative-time-btn').forEach(button => {
            const span = button.querySelector('.relative-time');
            const currentText = span.textContent;
            if (!currentText.includes('-')) {
                span.textContent = formatRelativeTime(button.dataset.timestamp);
            }
        });
    }, 60000);
    
    // Filter functionality
    document.querySelectorAll('.filter-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            updateItemVisibility();
        });
    });
    
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', updateItemVisibility);
    
    // Checkbox event listeners
    document.querySelectorAll('.file-checkbox').forEach(checkbox => {
        checkbox.addEventListener('click', function(event) {
            if (this.disabled) {
                event.preventDefault();
                const filename = this.dataset.filename;
                showFlashMessage(`Cannot select "${filename}" - file is expired or not available for download.`);
                return;
            }
            handleCheckboxClick(this, event);
        });
    });
    
    // Selection control buttons
    document.getElementById('selectAll').addEventListener('click', selectAllDownloadable);
    document.getElementById('clearSelection').addEventListener('click', clearSelection);
    document.getElementById('downloadSelected').addEventListener('click', downloadSelected);
    
    // Sticky selection control buttons
    document.getElementById('stickySelectAll').addEventListener('click', selectAllDownloadable);
    document.getElementById('stickyClearSelection').addEventListener('click', clearSelection);
    document.getElementById('stickyDownloadSelected').addEventListener('click', downloadSelected);
    
    // Auto-refresh processing jobs
    if (document.querySelectorAll('[data-status="processing"]').length > 0) {
        setInterval(() => location.reload(), 5000);
    }
});

// Toggle time display
function toggleTimeDisplay(element) {
    const span = element.querySelector('.relative-time');
    const currentText = span.textContent;
    const isRelative = !currentText.includes('-');
    
    span.textContent = isRelative 
        ? element.dataset.fullTime 
        : formatRelativeTime(element.dataset.timestamp);
}

// Refresh job status
async function refreshJobStatus(jobId) {
    try {
        const response = await fetch(`/api/process/status/${jobId}`);
        const data = await response.json();
        if (data.success) location.reload();
    } catch (error) {
        console.error('Error refreshing job status:', error);
    }
}
</script>
{% endblock %}
